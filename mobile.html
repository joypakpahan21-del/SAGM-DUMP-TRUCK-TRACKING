<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DT Driver - GPS Logger Real</title>
    
    <!-- PWA Meta Tags -->
    <meta name="theme-color" content="#007bff">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="manifest" href="manifest.json">
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <style>
        /* Enhanced Waypoint Datalogger Styles */
        .waypoint-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 12px;
        }
        
        .waypoint-stats {
            font-size: 1.1rem;
            font-weight: bold;
        }
        
        .waypoint-status {
            font-size: 0.85rem;
            opacity: 0.9;
        }
        
        .stats-card {
            background: white;
            border-radius: 10px;
            padding: 15px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            border: 1px solid #e9ecef;
        }
        
        .speed-gauge {
            font-size: 2rem;
            font-weight: bold;
            color: #198754;
            line-height: 1;
        }
        
        .distance-counter {
            font-size: 2rem;
            font-weight: bold;
            color: #0d6efd;
            line-height: 1;
        }
        
        .connection-status {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
        }
        
        .connection-status.connected {
            background-color: #198754;
            box-shadow: 0 0 8px #198754;
        }
        
        .connection-status.disconnected {
            background-color: #dc3545;
            box-shadow: 0 0 8px #dc3545;
        }
        
        /* Enhanced Chat Styles */
        .chat-toggle-btn {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 1000;
            border-radius: 25px;
            padding: 12px 20px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            transition: all 0.3s ease;
        }
        
        .chat-toggle-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(0,0,0,0.4);
        }
        
        .chat-window {
            position: fixed;
            bottom: 80px;
            right: 20px;
            width: 350px;
            height: 500px;
            background: white;
            border: 1px solid #ddd;
            border-radius: 12px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.2);
            z-index: 1001;
            display: none;
            flex-direction: column;
            overflow: hidden;
        }
        
        .chat-header {
            background: linear-gradient(135deg, #198754, #20c997);
            color: white;
            padding: 12px 15px;
            border-bottom: 1px solid #ddd;
        }
        
        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 15px;
            background: #f8f9fa;
        }
        
        .chat-input-container {
            padding: 15px;
            border-top: 1px solid #eee;
            background: white;
        }
        
        .chat-message {
            margin-bottom: 10px;
            padding: 8px 12px;
            border-radius: 12px;
            max-width: 85%;
            word-wrap: break-word;
        }
        
        .message-sent {
            background: #007bff;
            color: white;
            margin-left: auto;
            border-bottom-right-radius: 4px;
        }
        
        .message-received {
            background: #e9ecef;
            color: #333;
            margin-right: auto;
            border-bottom-left-radius: 4px;
        }
        
        .message-sender {
            font-size: 0.8rem;
            font-weight: bold;
            margin-bottom: 4px;
        }
        
        .message-time {
            font-size: 0.7rem;
            opacity: 0.7;
            margin-top: 4px;
        }
        
        .typing-indicator {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.8rem;
            color: #6c757d;
            padding: 8px;
        }
        
        .typing-dots {
            display: flex;
            gap: 3px;
        }
        
        .typing-dot {
            width: 6px;
            height: 6px;
            border-radius: 50%;
            background: #6c757d;
            animation: typing 1.4s infinite ease-in-out;
        }
        
        .typing-dot:nth-child(1) { animation-delay: -0.32s; }
        .typing-dot:nth-child(2) { animation-delay: -0.16s; }
        
        @keyframes typing {
            0%, 80%, 100% { transform: scale(0.8); opacity: 0.5; }
            40% { transform: scale(1); opacity: 1; }
        }
        
        .chat-placeholder {
            display: flex;
            align-items: center;
            justify-content: center;
            height: 100%;
            color: #6c757d;
        }
        
        /* GPS Instructions */
        .gps-instructions {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 8px;
            padding: 15px;
            margin-top: 15px;
        }
        
        /* Background Status Indicator */
        .background-indicator {
            position: fixed;
            top: 10px;
            right: 10px;
            background: rgba(0,0,0,0.7);
            color: white;
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 0.7rem;
            z-index: 1002;
            display: none;
        }
        
        /* Responsive Design */
        @media (max-width: 768px) {
            .chat-window {
                width: 90vw;
                right: 5vw;
                height: 60vh;
                bottom: 70px;
            }
            
            .chat-toggle-btn {
                right: 15px;
                bottom: 15px;
                padding: 10px 16px;
                font-size: 14px;
            }
            
            .waypoint-stats {
                font-size: 1rem;
            }
        }
        
        @media (max-width: 480px) {
            .chat-window {
                width: 95vw;
                right: 2.5vw;
                height: 55vh;
            }
            
            .speed-gauge, .distance-counter {
                font-size: 1.7rem;
            }
        }

        /* Additional Styles */
        .vehicle-info {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
            border-radius: 12px;
        }

        .control-btn {
            margin-bottom: 10px;
            padding: 12px;
            font-weight: bold;
        }

        .data-log {
            max-height: 200px;
            overflow-y: auto;
        }

        .gps-status-indicator {
            background: linear-gradient(135deg, #4ecdc4, #44a08d);
            color: white;
            padding: 8px 12px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: bold;
            margin-left: 10px;
        }

        .gps-mode-selector {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 10px;
            margin: 10px 0;
        }

        .debug-controls {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 15px;
            margin: 10px 0;
        }
    </style>
</head>
<body>
    <!-- Background Status Indicator -->
    <div class="background-indicator" id="backgroundIndicator">
        üîÑ Background Tracking Active
    </div>

    <!-- Login Screen -->
    <div class="container-fluid min-vh-100 d-flex align-items-center justify-content-center p-3">
        <div class="login-container p-4 w-100" style="max-width: 400px;" id="loginScreen">
            <div class="text-center mb-4">
                <div class="bg-primary text-white rounded-circle d-inline-flex align-items-center justify-content-center" 
                     style="width: 80px; height: 80px; font-size: 2rem;">
                    üöö
                </div>
                <h3 class="mt-3 text-dark">DT GPS Logger</h3>
                <p class="text-muted">Enhanced Background Tracking System</p>
            </div>

            <!-- GPS Mode Selector (Hanya Real GPS) -->
            <div class="gps-mode-selector mb-3">
                <label class="form-label fw-bold">üì° Mode GPS:</label>
                <div class="form-check">
                    <input class="form-check-input" type="radio" name="gpsMode" id="realGPS" value="real" checked>
                    <label class="form-check-label" for="realGPS">
                        üìç Real GPS (Mobile Device)
                    </label>
                </div>
                <div class="alert alert-info mt-2">
                    <small><strong>GPS Real Device</strong><br>
                    Sistem akan menggunakan GPS dari device Anda. Pastikan izin lokasi diaktifkan.</small>
                </div>
            </div>
            
            <form id="loginForm">
                <div class="mb-3">
                    <label class="form-label">Nama Driver</label>
                    <input type="text" class="form-control" id="driverName" placeholder="Masukkan nama lengkap" required>
                </div>
                <div class="mb-3">
                    <label class="form-label">Nomor Unit DT</label>
                    <select class="form-select" id="unitNumber" required>
                        <option value="">Pilih Unit DT</option>
                        <option value="DT-06">DT-06 - Dump Truck 2018</option>
                        <option value="DT-07">DT-07 - Dump Truck 2018</option>
                        <option value="DT-12">DT-12 - Dump Truck 2020</option>
                        <option value="DT-13">DT-13 - Dump Truck 2020</option>
                        <option value="DT-15">DT-15 - Dump Truck 2020</option>
                        <option value="DT-16">DT-16 - Dump Truck 2020</option>
                        <option value="DT-17">DT-17 - Dump Truck 2020</option>
                        <option value="DT-18">DT-18 - Dump Truck 2020</option>
                        <option value="DT-23">DT-23 - Dump Truck 2021</option>
                        <option value="DT-24">DT-24 - Dump Truck 2021</option>
                        <option value="DT-25">DT-25 - Dump Truck 2022</option>
                        <option value="DT-26">DT-26 - Dump Truck 2022</option>
                        <option value="DT-27">DT-27 - Dump Truck 2022</option>
                        <option value="DT-28">DT-28 - Dump Truck 2022</option>
                        <option value="DT-29">DT-29 - Dump Truck 2022</option>
                        <option value="DT-32">DT-32 - Dump Truck 2024</option>
                        <option value="DT-33">DT-33 - Dump Truck 2025</option>
                        <option value="DT-34">DT-34 - Dump Truck 2025</option>
                        <option value="DT-35">DT-35 - Dump Truck 2025</option>
                        <option value="DT-36">DT-36 - Dump Truck 2020</option>
                        <option value="DT-37">DT-37 - Dump Truck 2020</option>
                        <option value="DT-38">DT-38 - Dump Truck 2020</option>
                        <option value="DT-39">DT-39 - Dump Truck 2020</option>
                    </select>
                </div>
                <button type="submit" class="btn btn-primary w-100 py-2 fw-bold">
                    üöÄ Login & Start GPS
                </button>
            </form>

            <!-- GPS Instructions (akan ditampilkan jika ada error) -->
            <div class="gps-instructions" style="display: none;" id="gpsInstructions">
                <h6>üì± Cara Mengaktifkan GPS:</h6>
                <ol class="mb-1">
                    <li>Klik ikon <strong>üîí</strong> di address bar browser</li>
                    <li>Pilih <strong>"Site settings"</strong></li>
                    <li>Cari <strong>"Location"</strong> dan pilih <strong>"Allow"</strong></li>
                    <li>Refresh halaman ini</li>
                </ol>
                <small class="text-muted">Pastikan GPS/Lokasi device juga sudah diaktifkan</small>
            </div>
        </div>
    </div>

    <!-- Driver App Screen -->
    <div class="driver-app" id="driverApp" style="display: none;">
        <!-- Header -->
        <div class="row align-items-center m-3">
            <div class="col-8">
                <h5 class="mb-0">üöö DT Driver 
                    <span class="gps-status-indicator" id="gpsModeIndicator">üìç REAL GPS</span>
                </h5>
                <small class="text-muted" id="currentTime">--:--:--</small>
            </div>
            <div class="col-4 text-end">
                <span class="connection-status" id="connectionDot"></span>
                <span id="connectionStatus">MENYAMBUNG...</span>
            </div>
        </div>

        <!-- Vehicle Info -->
        <div class="vehicle-info p-3 m-3">
            <div class="row align-items-center">
                <div class="col-8">
                    <h4 class="mb-1 fw-bold" id="vehicleName">-</h4>
                    <small>Driver: <span id="driverDisplayName">-</span></small>
                </div>
                <div class="col-4 text-end">
                    <div class="bg-white text-dark rounded px-2 py-1">
                        <small class="fw-bold" id="vehicleStatus">READY</small>
                    </div>
                </div>
            </div>
        </div>

        <!-- ‚úÖ ENHANCED WAYPOINT DATALOGGER CARD -->
        <div class="card waypoint-card m-3">
            <div class="card-body">
                <h6 class="card-title mb-3">üìç ENHANCED WAYPOINT DATALOGGER</h6>
                <div class="row text-center">
                    <div class="col-4">
                        <small class="d-block opacity-75">Waypoints</small>
                        <div class="waypoint-stats" id="waypointCount">0</div>
                    </div>
                    <div class="col-4">
                        <small class="d-block opacity-75">Unsynced</small>
                        <div class="waypoint-stats" id="unsyncedCount">0</div>
                    </div>
                    <div class="col-4">
                        <small class="d-block opacity-75">Interval</small>
                        <div class="waypoint-stats">1s</div>
                    </div>
                </div>
                <div class="mt-2 text-center">
                    <small class="waypoint-status" id="waypointStatus">Mengumpulkan waypoint...</small>
                </div>
            </div>
        </div>

        <!-- Real-time Stats -->
        <div class="row m-2">
            <div class="col-6">
                <div class="stats-card text-center">
                    <small class="d-block text-muted">KECEPATAN</small>
                    <div class="speed-gauge" id="currentSpeed">0</div>
                    <small class="text-muted">km/h</small>
                </div>
            </div>
            <div class="col-6">
                <div class="stats-card text-center">
                    <small class="d-block text-muted">JARAK HARI INI</small>
                    <div class="distance-counter" id="todayDistance">0.0</div>
                    <small class="text-muted">kilometer</small>
                </div>
            </div>
        </div>

        <!-- GPS Data -->
        <div class="card m-3">
            <div class="card-body">
                <h6 class="card-title">üìç DATA GPS REAL-TIME</h6>
                <div class="gps-data p-3">
                    <div class="row">
                        <div class="col-6 mb-2">
                            <small class="text-muted d-block">LATITUDE</small>
                            <strong id="currentLat">-</strong>
                        </div>
                        <div class="col-6 mb-2">
                            <small class="text-muted d-block">LONGITUDE</small>
                            <strong id="currentLng">-</strong>
                        </div>
                        <div class="col-6">
                            <small class="text-muted d-block">AKURASI</small>
                            <strong id="gpsAccuracy">-</strong>
                        </div>
                        <div class="col-6">
                            <small class="text-muted d-block">ARAH</small>
                            <strong id="gpsBearing">-</strong>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Control Buttons -->
        <div class="row m-2">
            <div class="col-6">
                <button class="btn btn-success w-100 control-btn" id="startJourneyBtn">
                    üöÄ MULAI PERJALANAN
                </button>
            </div>
            <div class="col-6">
                <button class="btn btn-warning w-100 control-btn" id="pauseJourneyBtn">
                    ‚è∏Ô∏è JEDA
                </button>
            </div>
            <div class="col-6">
                <button class="btn btn-info w-100 control-btn" id="reportIssueBtn">
                    üö® LAPOR MASALAH
                </button>
            </div>
            <div class="col-6">
                <button class="btn btn-danger w-100 control-btn" id="endJourneyBtn">
                    ‚úÖ SELESAI
                </button>
            </div>
        </div>

        <!-- Debug Controls -->
        <div class="card m-3">
            <div class="card-body">
                <h6 class="card-title">üõ†Ô∏è DEBUG CONTROLS</h6>
                <div class="row text-center">
                    <div class="col-4">
                        <button class="btn btn-outline-success btn-sm w-100" id="sendTestMessageBtn">
                            üí¨ Test Chat
                        </button>
                    </div>
                    <div class="col-4">
                        <button class="btn btn-outline-info btn-sm w-100" id="forceSyncBtn">
                            üîÑ Force Sync
                        </button>
                    </div>
                    <div class="col-4">
                        <button class="btn btn-outline-warning btn-sm w-100" id="gpsDiagnosticBtn">
                            üì° GPS Check
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Session Info -->
        <div class="card m-3">
            <div class="card-body">
                <h6 class="card-title">üìä INFO SESI</h6>
                <div class="row text-center">
                    <div class="col-4">
                        <small class="text-muted d-block">DURASI</small>
                        <strong id="sessionDuration">00:00:00</strong>
                    </div>
                    <div class="col-4">
                        <small class="text-muted d-block">DATA POINTS</small>
                        <strong id="dataPoints">0</strong>
                    </div>
                    <div class="col-4">
                        <small class="text-muted d-block">RATA-RATA</small>
                        <strong id="avgSpeed">0</strong>
                    </div>
                </div>
            </div>
        </div>

        <!-- Data Log -->
        <div class="card m-3">
            <div class="card-body">
                <h6 class="card-title">üìù LOG TRANSMISI DATA</h6>
                <div class="data-log" id="dataLogs">
                    <div class="alert alert-info py-2 mb-2">
                        <small>System: Menunggu inisialisasi GPS...</small>
                    </div>
                </div>
            </div>
        </div>

        <!-- Logout Button -->
        <div class="m-3">
            <button class="btn btn-danger w-100 py-2 fw-bold" id="logoutBtn">
                üîì Logout
            </button>
        </div>
    </div>

    <!-- ‚úÖ ENHANCED CHAT INTERFACE -->
    <div id="chatContainer">
        <!-- Chat Toggle Button -->
        <button id="chatToggle" class="btn btn-primary chat-toggle-btn">
            üí¨ Chat <span id="unreadBadge" class="badge bg-danger" style="display: none;"></span>
        </button>
        
        <!-- Chat Window -->
        <div id="chatWindow" class="chat-window">
            <div class="chat-header">
                <h6 class="mb-0">üí¨ Chat dengan Monitor</h6>
                <button type="button" class="btn-close btn-close-white" id="closeChatBtn"></button>
            </div>
            
            <div id="chatMessages" class="chat-messages">
                <div class="chat-placeholder text-center text-muted py-4">
                    <small>Mulai percakapan dengan monitor...</small>
                </div>
            </div>
            
            <div class="chat-input-container">
                <div class="input-group">
                    <input type="text" id="chatInput" class="form-control" 
                           placeholder="Ketik pesan...">
                    <button class="btn btn-primary" type="button" id="sendChatBtn">
                        Kirim
                    </button>
                </div>
                <small class="text-muted d-block mt-1">Tekan Enter untuk mengirim</small>
            </div>
        </div>
    </div>

    <!-- FIREBASE SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-database-compat.js"></script>
    <script>
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('/service-worker.js')
                .then(registration => {
                    console.log('SW registered for mobile');
                    // Identify as mobile context
                    registration.active?.postMessage({
                        type: 'CONTEXT_IDENTIFICATION', 
                        context: 'mobile'
                    });
                });
        }
    </script>

    <script>
// ==== FIREBASE CONFIG ====
const FIREBASE_CONFIG = {
    apiKey: "AIzaSyBMiER_5b51IEEoxivkCliRC0WID1f-yzk",
    authDomain: "joi-gps-tracker.firebaseapp.com",
    databaseURL: "https://joi-gps-tracker-default-rtdb.asia-southeast1.firebasedatabase.app",
    projectId: "joi-gps-tracker",
    storageBucket: "joi-gps-tracker.firebasestorage.app",
    messagingSenderId: "216572191895",
    appId: "1:216572191895:web:a4fef1794daf200a2775d2"
};

// Initialize Firebase
firebase.initializeApp(FIREBASE_CONFIG);
const database = firebase.database();

// ‚úÖ BACKGROUND TRACKING MANAGER
class BackgroundTrackingManager {
    constructor(logger) {
        this.logger = logger;
        this.isActive = false;
        this.backgroundWatchId = null;
        this.backgroundInterval = null;
        this.isInBackground = false;
        this.lastBackgroundPosition = null;
        this.backgroundUpdateCount = 0;
    }

    start() {
        if (this.isActive) return;
        
        console.log('üîÑ Starting enhanced background tracking...');
        this.isActive = true;
        
        // Setup visibility handlers
        this.setupVisibilityHandlers();
        
        // Start background position watching with optimized settings
        this.startBackgroundPositionWatch();
        
        // Background data processing interval
        this.backgroundInterval = setInterval(() => {
            this.processBackgroundData();
        }, 15000); // Process every 15 seconds in background
        
        this.updateBackgroundIndicator();
    }

    setupVisibilityHandlers() {
        document.addEventListener('visibilitychange', () => {
            this.isInBackground = document.hidden;
            
            if (this.isInBackground) {
                console.log('üì± App moved to background - optimizing tracking');
                this.onEnterBackground();
            } else {
                console.log('üì± App returned to foreground');
                this.onEnterForeground();
            }
            
            this.updateBackgroundIndicator();
        });

        // Additional events for better background detection
        window.addEventListener('pagehide', () => {
            this.isInBackground = true;
            this.onEnterBackground();
        });

        window.addEventListener('pageshow', () => {
            this.isInBackground = false;
            this.onEnterForeground();
        });

        // Handle beforeunload to persist session
        window.addEventListener('beforeunload', () => {
            if (this.logger.driverData) {
                this.logger.persistSession();
            }
        });
    }

    startBackgroundPositionWatch() {
        if (!navigator.geolocation) return;

        const backgroundOptions = {
            enableHighAccuracy: true,
            timeout: 30000, // Longer timeout for background
            maximumAge: 60000 // Accept older positions in background
        };

        if (this.backgroundWatchId) {
            navigator.geolocation.clearWatch(this.backgroundWatchId);
        }

        this.backgroundWatchId = navigator.geolocation.watchPosition(
            (position) => this.handleBackgroundPosition(position),
            (error) => this.handleBackgroundError(error),
            backgroundOptions
        );
    }

    handleBackgroundPosition(position) {
        this.lastBackgroundPosition = position;
        this.backgroundUpdateCount++;
        
        // Process position immediately if in foreground or significant movement
        if (!this.isInBackground || this.isSignificantMovement(position)) {
            this.processBackgroundPosition(position);
        }
    }

    isSignificantMovement(newPosition) {
        if (!this.lastBackgroundPosition) return true;
        
        const distance = this.calculateDistance(
            this.lastBackgroundPosition.coords.latitude,
            this.lastBackgroundPosition.coords.longitude,
            newPosition.coords.latitude,
            newPosition.coords.longitude
        );
        
        return distance > 0.02; // 20 meters minimum movement
    }

    calculateDistance(lat1, lon1, lat2, lon2) {
        const R = 6371;
        const dLat = (lat2 - lat1) * Math.PI / 180;
        const dLon = (lon2 - lon1) * Math.PI / 180;
        const a = 
            Math.sin(dLat/2) * Math.sin(dLat/2) +
            Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) * 
            Math.sin(dLon/2) * Math.sin(dLon/2);
        const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
        return R * c;
    }

    processBackgroundPosition(position) {
        if (!this.logger.driverData || !this.logger.isTracking) return;

        const accuracy = position.coords.accuracy;
        
        // More lenient accuracy check for background
        if (accuracy > 200) {
            console.log('üîÑ Background position accuracy too low, skipping');
            return;
        }

        const waypoint = {
            id: `wp_bg_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`,
            lat: parseFloat(position.coords.latitude.toFixed(6)),
            lng: parseFloat(position.coords.longitude.toFixed(6)),
            accuracy: parseFloat(accuracy.toFixed(1)),
            speed: position.coords.speed ? parseFloat((position.coords.speed * 3.6).toFixed(1)) : 0,
            bearing: position.coords.heading ? parseFloat(position.coords.heading.toFixed(0)) : null,
            timestamp: new Date().toISOString(),
            timeDisplay: new Date().toLocaleTimeString('id-ID'),
            sessionId: this.logger.driverData.sessionId,
            unit: this.logger.driverData.unit,
            driver: this.logger.driverData.name,
            synced: false,
            isOnline: this.logger.isOnline,
            lowAccuracy: accuracy > 50,
            isSimulated: false,
            isBackground: true,
            batteryLevel: this.logger.getBatteryLevel()
        };

        this.logger.processWaypoint(waypoint);
        
        // Update last position for distance calculation
        this.logger.lastPosition = {
            lat: waypoint.lat,
            lng: waypoint.lng,
            speed: waypoint.speed,
            accuracy: waypoint.accuracy,
            bearing: waypoint.bearing,
            timestamp: new Date()
        };

        // Persist session data
        this.logger.persistSession();
    }

    processBackgroundData() {
        if (!this.isInBackground || !this.lastBackgroundPosition) return;
        
        console.log('üîÑ Processing background data...');
        this.processBackgroundPosition(this.lastBackgroundPosition);
        
        // Send to Firebase every few background updates
        if (this.backgroundUpdateCount % 3 === 0 && this.logger.lastPosition) {
            this.logger.sendToFirebase();
        }
    }

    handleBackgroundError(error) {
        console.warn('Background GPS Error:', error);
        // Don't show user-facing alerts in background
    }

    onEnterBackground() {
        // Reduce UI updates but continue tracking
        console.log('üéØ Background mode: Continuing tracking with optimized settings');
        
        // Show background indicator
        this.updateBackgroundIndicator(true);
    }

    onEnterForeground() {
        // Restore normal operation
        console.log('üéØ Foreground mode: Restoring full functionality');
        
        // Hide background indicator
        this.updateBackgroundIndicator(false);
        
        // Force sync when returning to foreground
        if (this.logger.isOnline) {
            setTimeout(() => {
                this.logger.syncWaypointsToServer();
                this.logger.offlineQueue.processQueue();
            }, 2000);
        }
    }

    updateBackgroundIndicator(show = false) {
        const indicator = document.getElementById('backgroundIndicator');
        if (indicator) {
            if (show && this.isInBackground) {
                indicator.style.display = 'block';
                indicator.textContent = 'üîÑ Background Tracking Active';
            } else {
                indicator.style.display = 'none';
            }
        }
    }

    stop() {
        console.log('üõë Stopping background tracking...');
        this.isActive = false;
        
        if (this.backgroundWatchId) {
            navigator.geolocation.clearWatch(this.backgroundWatchId);
            this.backgroundWatchId = null;
        }
        
        if (this.backgroundInterval) {
            clearInterval(this.backgroundInterval);
            this.backgroundInterval = null;
        }
        
        this.lastBackgroundPosition = null;
        this.backgroundUpdateCount = 0;
        
        this.updateBackgroundIndicator(false);
    }
}

// ‚úÖ ENHANCED CIRCULAR BUFFER IMPLEMENTATION
class CircularBuffer {
    constructor(capacity) {
        this.capacity = capacity;
        this.buffer = new Array(capacity);
        this.head = 0;
        this.tail = 0;
        this._count = 0;
        this.isFull = false;
    }

    push(item) {
        this.buffer[this.tail] = item;
        this.tail = (this.tail + 1) % this.capacity;
        
        if (this.isFull) {
            this.head = (this.head + 1) % this.capacity;
        } else {
            this._count++;
            if (this._count === this.capacity) {
                this.isFull = true;
            }
        }
    }

    getAll() {
        if (this._count === 0) return [];
        
        const result = [];
        if (this.isFull) {
            for (let i = 0; i < this.capacity; i++) {
                const index = (this.head + i) % this.capacity;
                result.push(this.buffer[index]);
            }
        } else {
            for (let i = 0; i < this._count; i++) {
                result.push(this.buffer[i]);
            }
        }
        return result;
    }

    getUnsynced() {
        return this.getAll().filter(wp => !wp.synced);
    }

    clear() {
        this.head = 0;
        this.tail = 0;
        this._count = 0;
        this.isFull = false;
        this.buffer = new Array(this.capacity);
    }

    get count() {
        return this.isFull ? this.capacity : this._count;
    }
}

// ‚úÖ ENHANCED STORAGE MANAGER WITH SESSION PERSISTENCE
class EnhancedStorageManager {
    constructor() {
        this.STORAGE_KEYS = {
            WAYPOINTS: 'enhanced_gps_waypoints',
            SYNC_STATUS: 'enhanced_sync_status',
            SESSION_DATA: 'enhanced_session_data',
            PERSISTED_SESSION: 'dt_gps_persisted_session'
        };
    }

    saveWaypoint(waypoint) {
        try {
            const existing = this.loadAllWaypoints();
            
            // Smart storage management - remove oldest 10% when near capacity
            if (existing.length >= 61200) {
                const removeCount = Math.floor(existing.length * 0.1);
                existing.splice(0, removeCount);
                console.log(`üóëÔ∏è Removed ${removeCount} old waypoints to free space`);
            }
            
            existing.push(waypoint);
            this.saveToStorage(existing);
            
            this.updateSyncStatus({
                totalWaypoints: existing.length,
                unsyncedCount: existing.filter(w => !w.synced).length,
                lastSave: new Date().toISOString()
            });
            
        } catch (error) {
            console.error('Failed to save waypoint:', error);
            this.handleStorageError(error);
        }
    }

    loadAllWaypoints() {
        try {
            const data = localStorage.getItem(this.STORAGE_KEYS.WAYPOINTS);
            return data ? JSON.parse(data) : [];
        } catch (error) {
            console.error('Failed to load waypoints:', error);
            return [];
        }
    }

    loadUnsyncedWaypoints() {
        const all = this.loadAllWaypoints();
        return all.filter(waypoint => !waypoint.synced);
    }

    markWaypointsAsSynced(waypointIds) {
        try {
            const all = this.loadAllWaypoints();
            const updated = all.map(waypoint => {
                if (waypointIds.includes(waypoint.id)) {
                    return { ...waypoint, synced: true };
                }
                return waypoint;
            });
            
            this.saveToStorage(updated);
            
            this.updateSyncStatus({
                totalWaypoints: updated.length,
                unsyncedCount: updated.filter(w => !w.synced).length,
                lastSync: new Date().toISOString()
            });
        } catch (error) {
            console.error('Error marking waypoints as synced:', error);
        }
    }

    saveToStorage(waypoints) {
        try {
            localStorage.setItem(this.STORAGE_KEYS.WAYPOINTS, JSON.stringify(waypoints));
        } catch (error) {
            console.error('Error saving to storage:', error);
            this.handleStorageError(error);
        }
    }

    updateSyncStatus(status) {
        try {
            const existing = this.getSyncStatus();
            localStorage.setItem(this.STORAGE_KEYS.SYNC_STATUS, JSON.stringify({
                ...existing, ...status, updatedAt: new Date().toISOString()
            }));
        } catch (error) {
            console.error('Error updating sync status:', error);
        }
    }

    getSyncStatus() {
        try {
            const data = localStorage.getItem(this.STORAGE_KEYS.SYNC_STATUS);
            return data ? JSON.parse(data) : {
                totalWaypoints: 0, unsyncedCount: 0, lastSync: null, lastSave: null
            };
        } catch (error) {
            return { totalWaypoints: 0, unsyncedCount: 0, lastSync: null, lastSave: null };
        }
    }

    // ‚úÖ SESSION PERSISTENCE METHODS
    persistSession(sessionData) {
        try {
            if (!sessionData) return;
            
            const sessionToSave = {
                ...sessionData,
                persistedAt: new Date().toISOString(),
                appState: document.hidden ? 'background' : 'foreground'
            };
            
            localStorage.setItem(this.STORAGE_KEYS.PERSISTED_SESSION, JSON.stringify(sessionToSave));
            console.log('üíæ Session data persisted');
        } catch (error) {
            console.error('Error persisting session:', error);
        }
    }

    loadPersistedSession() {
        try {
            const data = localStorage.getItem(this.STORAGE_KEYS.PERSISTED_SESSION);
            return data ? JSON.parse(data) : null;
        } catch (error) {
            console.error('Error loading persisted session:', error);
            return null;
        }
    }

    clearPersistedSession() {
        try {
            localStorage.removeItem(this.STORAGE_KEYS.PERSISTED_SESSION);
            console.log('üóëÔ∏è Persisted session cleared');
        } catch (error) {
            console.error('Error clearing persisted session:', error);
        }
    }

    handleStorageError(error) {
        // Handle storage quota exceeded errors
        if (error.name === 'QuotaExceededError' || error.code === 22) {
            console.warn('Storage quota exceeded, clearing old data...');
            // Clear oldest 25% of waypoints
            const allWaypoints = this.loadAllWaypoints();
            const removeCount = Math.floor(allWaypoints.length * 0.25);
            const remaining = allWaypoints.slice(removeCount);
            this.saveToStorage(remaining);
            
            this.updateSyncStatus({
                totalWaypoints: remaining.length,
                unsyncedCount: remaining.filter(w => !w.synced).length,
                lastSave: new Date().toISOString()
            });
        }
    }
}

// ‚úÖ ENHANCED MOBILE GPS LOGGER WITH BACKGROUND SUPPORT
class EnhancedDTGPSLogger {
    constructor() {
        this.waypointConfig = {
            collectionInterval: 1000,
            maxWaypoints: 61200,
            batchSize: 100,
            syncInterval: 30000,
        };

        this.waypointBuffer = new CircularBuffer(this.waypointConfig.maxWaypoints);
        this.unsyncedWaypoints = new Set();
        this.storageManager = new EnhancedStorageManager();
        
        this.driverData = null;
        this.watchId = null;
        this.isTracking = false;
        this.sendInterval = null;
        this.sessionStartTime = null;
        this.totalDistance = 0;
        this.lastPosition = null;
        this.dataPoints = 0;
        this.isOnline = false;
        this.journeyStatus = 'ready';
        this.firebaseRef = null;
        
        this.lastUpdateTime = null;
        this.currentSpeed = 0;
        this.speedHistory = [];
        this.movingStartTime = null;
        this.isCurrentlyMoving = false;
        
        this.completeHistory = this.loadCompleteHistory();
        
        // ‚úÖ BACKGROUND TRACKING
        this.backgroundManager = new BackgroundTrackingManager(this);
        this.isInBackground = false;
        
        this.chatRef = null;
        this.chatMessages = [];
        this.unreadCount = 0;
        this.isChatOpen = false;
        this.chatInitialized = false;
        this.lastMessageId = null;
        
        this.offlineQueue = new OfflineQueueManager();
        
        this.init();
    }

    init() {
        this.setupEventListeners();
        this.updateTime();
        this.checkNetworkStatus();
        setInterval(() => this.updateTime(), 1000);
        setInterval(() => this.checkNetworkStatus(), 5000);
        
        this.loadUnsyncedWaypoints();
        this.checkPersistedSession(); // Check for existing session
        
        console.log('üöÄ Enhanced DT GPS Logger initialized - BACKGROUND TRACKING READY');
    }

    // ‚úÖ SESSION PERSISTENCE
    checkPersistedSession() {
        const persistedSession = this.storageManager.loadPersistedSession();
        if (persistedSession && persistedSession.driverData) {
            console.log('üìÇ Found persisted session, attempting to restore...');
            
            // Check if session is not too old (max 24 hours)
            const persistedAt = new Date(persistedSession.persistedAt);
            const now = new Date();
            const hoursDiff = (now - persistedAt) / (1000 * 60 * 60);
            
            if (hoursDiff < 24) {
                this.restoreSession(persistedSession);
            } else {
                console.log('üïí Persisted session too old, discarding...');
                this.storageManager.clearPersistedSession();
            }
        }
    }

    restoreSession(sessionData) {
        if (!sessionData.driverData) return;
        
        try {
            this.driverData = sessionData.driverData;
            this.totalDistance = sessionData.trackingData?.totalDistance || 0;
            this.dataPoints = sessionData.trackingData?.dataPoints || 0;
            this.sessionStartTime = new Date(sessionData.trackingData?.sessionStartTime || new Date());
            this.journeyStatus = sessionData.trackingData?.journeyStatus || 'ready';
            this.currentSpeed = sessionData.trackingData?.currentSpeed || 0;
            
            // Restore Firebase reference
            this.firebaseRef = database.ref('/units/' + this.driverData.unit);
            
            // Show driver app
            this.showDriverApp();
            
            // Start background tracking immediately
            this.backgroundManager.start();
            
            // Start data transmission
            this.startDataTransmission();
            
            this.addLog('‚úÖ Session dipulihkan - tracking berjalan di background', 'success');
            this.addLog(`üìä Data sebelumnya: ${this.totalDistance.toFixed(3)} km, ${this.dataPoints} waypoints`, 'info');
            
        } catch (error) {
            console.error('Error restoring session:', error);
            this.storageManager.clearPersistedSession();
        }
    }

    persistSession() {
        if (!this.driverData) return;
        
        const sessionData = {
            driverData: this.driverData,
            trackingData: {
                totalDistance: this.totalDistance,
                dataPoints: this.dataPoints,
                sessionStartTime: this.sessionStartTime,
                journeyStatus: this.journeyStatus,
                currentSpeed: this.currentSpeed,
                lastPersist: new Date().toISOString()
            }
        };
        
        this.storageManager.persistSession(sessionData);
    }

    clearPersistedSession() {
        this.storageManager.clearPersistedSession();
    }

    setupEventListeners() {
        const loginForm = document.getElementById('loginForm');
        if (loginForm) {
            loginForm.addEventListener('submit', (e) => {
                e.preventDefault();
                this.handleLogin();
            });
        }

        this.setupButtonListeners();
        
        // Enhanced visibility handling
        document.addEventListener('visibilitychange', () => {
            this.isInBackground = document.hidden;
            if (this.driverData) {
                this.persistSession(); // Persist on visibility change
            }
        });
    }

    setupButtonListeners() {
        // Control buttons
        document.getElementById('startJourneyBtn')?.addEventListener('click', () => this.startJourney());
        document.getElementById('pauseJourneyBtn')?.addEventListener('click', () => this.pauseJourney());
        document.getElementById('endJourneyBtn')?.addEventListener('click', () => this.endJourney());
        document.getElementById('reportIssueBtn')?.addEventListener('click', () => this.reportIssue());
        document.getElementById('logoutBtn')?.addEventListener('click', () => this.logout());

        // Debug controls
        document.getElementById('sendTestMessageBtn')?.addEventListener('click', () => this.sendTestMessage());
        document.getElementById('forceSyncBtn')?.addEventListener('click', () => this.forceSync());
        document.getElementById('gpsDiagnosticBtn')?.addEventListener('click', () => this.runGPSDiagnostic());

        // Chat buttons
        document.getElementById('chatToggle')?.addEventListener('click', () => this.toggleChat());
        document.getElementById('closeChatBtn')?.addEventListener('click', () => this.toggleChat());
        document.getElementById('sendChatBtn')?.addEventListener('click', () => this.sendChatMessage());
        
        const chatInput = document.getElementById('chatInput');
        if (chatInput) {
            chatInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    this.sendChatMessage();
                }
            });
        }
    }

    // ‚úÖ ENHANCED GPS ACCURACY HANDLING
    startRealGPSTracking() {
        if (!navigator.geolocation) {
            this.addLog('‚ùå GPS tidak didukung di browser ini', 'error');
            this.showGPSInstructions();
            return;
        }

        console.log('üìç Starting ENHANCED REAL GPS tracking...');
        
        const options = {
            enableHighAccuracy: true,
            timeout: 15000,
            maximumAge: 5000, // Accept positions up to 5 seconds old
            distanceFilter: 1 // Minimum distance between updates in meters
        };

        // Clear previous watch
        if (this.watchId) {
            navigator.geolocation.clearWatch(this.watchId);
        }

        this.watchId = navigator.geolocation.watchPosition(
            (position) => this.handleEnhancedPositionUpdate(position),
            (error) => this.handleGPSError(error),
            options
        );

        this.isTracking = true;
        this.addLog('üìç Enhanced GPS Real diaktifkan', 'success');
        
        // Request high-accuracy position for initial fix
        navigator.geolocation.getCurrentPosition(
            (pos) => {
                const accuracy = pos.coords.accuracy;
                this.addLog(`‚úÖ GPS Aktif - Akurasi: ${accuracy}m`, 'success');
                if (accuracy > 50) {
                    this.addLog('üí° Tips: Cari area terbuka untuk akurasi lebih baik', 'info');
                }
            },
            (err) => {
                this.addLog('‚ö†Ô∏è GPS butuh izin - pastikan izin lokasi diaktifkan', 'warning');
            },
            { enableHighAccuracy: true, timeout: 10000 }
        );
    }

    handleEnhancedPositionUpdate(position) {
        const accuracy = position.coords.accuracy;
        
        // Enhanced accuracy validation
        if (accuracy > 1000) {
            console.warn(`‚ö†Ô∏è Akurasi GPS sangat rendah: ${accuracy}m`);
            this.addLog(`‚ö†Ô∏è Akurasi sangat rendah (${accuracy}m) - data mungkin tidak akurat`, 'warning');
            // Continue processing but mark as low accuracy
        }

        // Enhanced coordinate validation
        if (!this.isValidCoordinate(position.coords.latitude, position.coords.longitude)) {
            console.warn('‚ùå Invalid coordinates detected, skipping');
            return;
        }

        const currentPosition = {
            lat: parseFloat(position.coords.latitude.toFixed(6)),
            lng: parseFloat(position.coords.longitude.toFixed(6)),
            accuracy: parseFloat(accuracy.toFixed(1)),
            speed: position.coords.speed ? parseFloat((position.coords.speed * 3.6).toFixed(1)) : 0,
            bearing: position.coords.heading ? parseFloat(position.coords.heading.toFixed(0)) : null,
            timestamp: new Date(),
            isOnline: this.isOnline,
            altitude: position.coords.altitude ? parseFloat(position.coords.altitude.toFixed(1)) : null,
            altitudeAccuracy: position.coords.altitudeAccuracy ? parseFloat(position.coords.altitudeAccuracy.toFixed(1)) : null
        };

        // Enhanced distance calculation with better filtering
        this.calculateDistanceWithCoordinates(currentPosition);

        // Process waypoint with improved validation
        this.processWaypoint({
            ...currentPosition,
            id: `wp_real_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`,
            sessionId: this.driverData?.sessionId || 'unknown',
            unit: this.driverData?.unit || 'unknown',
            driver: this.driverData?.name || 'unknown',
            synced: false,
            lowAccuracy: accuracy > 50,
            isBackground: this.isInBackground,
            batteryLevel: this.getBatteryLevel()
        });

        this.lastPosition = currentPosition;
        
        // Persist session data periodically
        if (this.dataPoints % 10 === 0) {
            this.persistSession();
        }
    }

    // ‚úÖ ENHANCED COORDINATE VALIDATION
    isValidCoordinate(lat, lng) {
        if (lat == null || lng == null || isNaN(lat) || isNaN(lng)) {
            return false;
        }
        
        if (lat < -90 || lat > 90 || lng < -180 || lng > 180) {
            return false;
        }
        
        // Check for obviously invalid coordinates (0,0 or null island)
        if (lat === 0 && lng === 0) {
            return false;
        }
        
        // Check for reasonable coordinate values (adjust based on your region)
        // Indonesia coordinates roughly between 95¬∞E and 141¬∞E, 11¬∞S and 6¬∞N
        if (lng < 95 || lng > 141 || lat < -11 || lat > 6) {
            console.warn('Koordinat di luar area Indonesia:', lat, lng);
            // Don't return false - just warn, as users might travel outside Indonesia
        }
        
        return true;
    }

    // ‚úÖ ENHANCED DISTANCE CALCULATION
    calculateDistanceWithCoordinates(currentPosition) {
        if (!this.lastPosition || !this.lastPosition.timestamp) {
            this.lastPosition = currentPosition;
            return 0;
        }

        const timeDiffMs = currentPosition.timestamp - this.lastPosition.timestamp;
        
        // Skip if time difference is too small
        if (timeDiffMs < 1000) {
            return 0;
        }

        const distanceKm = this.haversineDistance(
            this.lastPosition.lat, 
            this.lastPosition.lng,
            currentPosition.lat, 
            currentPosition.lng
        );

        const timeDiffHours = timeDiffMs / 1000 / 3600;

        // Enhanced accuracy filtering
        const maxAccuracy = 500; // Reduced for better accuracy
        if (currentPosition.accuracy > maxAccuracy) {
            console.warn(`üéØ Akurasi GPS ${currentPosition.accuracy}m terlalu rendah, skip perhitungan jarak`);
            return 0;
        }

        const minDistance = 0.003; // 3 meters minimum movement
        if (distanceKm < minDistance) {
            return 0;
        }

        let actualSpeed = 0;
        if (timeDiffHours > 0) {
            actualSpeed = distanceKm / timeDiffHours;
            
            const MAX_REALISTIC_SPEED = 120;
            if (actualSpeed > MAX_REALISTIC_SPEED) {
                console.warn(`üö´ Kecepatan ${actualSpeed.toFixed(1)} km/h tidak realistis, diabaikan`);
                return 0;
            }
        }

        if (actualSpeed > 1 && this.journeyStatus === 'started') { // Reduced threshold for better sensitivity
            this.totalDistance += distanceKm;
            
            this.currentSpeed = this.enhancedSmoothSpeed(actualSpeed);
            
            // Update UI if app is in foreground
            if (!this.isInBackground) {
                document.getElementById('todayDistance').textContent = this.totalDistance.toFixed(3);
                document.getElementById('currentSpeed').textContent = this.currentSpeed.toFixed(1);
            }
            
            console.log(`üìè +${(distanceKm * 1000).toFixed(1)}m | üöÄ ${actualSpeed.toFixed(1)} km/h | Total: ${this.totalDistance.toFixed(3)}km`);
            
            this.updateAverageSpeed();
            
            return distanceKm;
        }
        
        return 0;
    }

    // ‚úÖ ENHANCED SMOOTHING ALGORITHM
    enhancedSmoothSpeed(newSpeed) {
        if (!this.speedHistory) {
            this.speedHistory = [];
        }
        
        this.speedHistory.push(newSpeed);
        
        // Use larger window for better smoothing
        if (this.speedHistory.length > 8) {
            this.speedHistory.shift();
        }
        
        // Use weighted average (recent values have more weight)
        const weights = [1, 1, 1, 1.2, 1.2, 1.5, 1.5, 2];
        let sum = 0;
        let weightSum = 0;
        
        this.speedHistory.forEach((speed, index) => {
            const weight = weights[Math.min(index, weights.length - 1)] || 1;
            sum += speed * weight;
            weightSum += weight;
        });
        
        return sum / weightSum;
    }

    haversineDistance(lat1, lon1, lat2, lon2) {
        const R = 6371; // Radius bumi dalam kilometer
        
        const dLat = (lat2 - lat1) * Math.PI / 180;
        const dLon = (lon2 - lon1) * Math.PI / 180;
        
        const a = 
            Math.sin(dLat/2) * Math.sin(dLat/2) +
            Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) * 
            Math.sin(dLon/2) * Math.sin(dLon/2);
        
        const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
        const distance = R * c;
        
        return distance;
    }

    // ‚úÖ ENHANCED ERROR HANDLING
    handleGPSError(error) {
        let message = '';
        let instructions = '';
        
        switch(error.code) {
            case error.PERMISSION_DENIED:
                message = '‚ùå Izin GPS Ditolak';
                instructions = 'üì± Buka: Settings ‚Üí Site Settings ‚Üí Location ‚Üí Allow';
                this.showGPSInstructions();
                break;
                
            case error.POSITION_UNAVAILABLE:
                message = '‚ùå GPS Device Tidak Aktif';
                instructions = 'Aktifkan GPS/Lokasi di pengaturan device dan pastikan sinyal baik';
                break;
                
            case error.TIMEOUT:
                message = '‚è±Ô∏è Timeout GPS';
                instructions = 'Cari area dengan sinyal lebih baik atau restart GPS';
                break;
                
            default:
                message = '‚ùå Error GPS Tidak Diketahui';
                instructions = 'Coba restart aplikasi atau device';
                break;
        }
        
        this.addLog(`${message} - ${instructions}`, 'error');
        
        // Try to recover by requesting position again after delay
        if (error.code !== error.PERMISSION_DENIED) {
            setTimeout(() => {
                if (this.isTracking) {
                    navigator.geolocation.getCurrentPosition(
                        () => this.addLog('‚úÖ GPS berhasil dipulihkan', 'success'),
                        (err) => console.warn('GPS recovery failed:', err),
                        { enableHighAccuracy: false, timeout: 10000 }
                    );
                }
            }, 10000);
        }
    }

    showGPSInstructions() {
        const instructions = document.getElementById('gpsInstructions');
        if (instructions) {
            instructions.style.display = 'block';
        }
    }

    // ‚úÖ BATTERY OPTIMIZATION METHODS
    optimizeBatteryUsage() {
        if (this.isInBackground) {
            // Reduce update frequency in background
            if (this.sendInterval) {
                clearInterval(this.sendInterval);
                this.sendInterval = setInterval(() => {
                    if (this.lastPosition) {
                        this.sendToFirebase();
                    }
                }, 30000); // 30 seconds in background
            }
        } else {
            // Normal frequency in foreground
            if (this.sendInterval) {
                clearInterval(this.sendInterval);
                this.startDataTransmission();
            }
        }
    }

    startDataTransmission() {
        if (this.sendInterval) {
            clearInterval(this.sendInterval);
        }
        
        this.sendInterval = setInterval(() => {
            if (this.lastPosition) {
                this.sendToFirebase();
            }
        }, this.isInBackground ? 30000 : 5000); // Adaptive interval
    }

    // ‚úÖ CORE APPLICATION METHODS (Updated for Background Support)
    handleLogin() {
        const driverName = document.getElementById('driverName');
        const unitNumber = document.getElementById('unitNumber');

        if (driverName && unitNumber && driverName.value && unitNumber.value) {
            this.driverData = {
                name: driverName.value,
                unit: unitNumber.value,
                year: this.getVehicleYear(unitNumber.value),
                sessionId: this.generateSessionId()
            };

            this.firebaseRef = database.ref('/units/' + this.driverData.unit);
            
            const cleanData = {
                driver: this.driverData.name,
                unit: this.driverData.unit,
                sessionId: this.driverData.sessionId,
                journeyStatus: 'ready',
                lastUpdate: new Date().toLocaleTimeString('id-ID'),
                lat: 0, lng: 0, speed: 0, distance: 0,
                fuel: 100, accuracy: 0, timestamp: new Date().toISOString(),
                gpsMode: 'real',
                isActive: true,
                batteryLevel: this.getBatteryLevel()
            };

            this.firebaseRef.set(cleanData);
            this.showDriverApp();
            this.startDataTransmission();
            
            // Start background tracking
            this.backgroundManager.start();
            
            // Persist session immediately
            this.persistSession();
            
            setTimeout(() => {
                this.startJourney();
            }, 2000);
        } else {
            alert('Harap isi semua field!');
        }
    }

    getVehicleYear(unit) {
        const yearMap = {
            'DT-06': '2018', 'DT-07': '2018', 'DT-12': '2020', 'DT-13': '2020', 
            'DT-15': '2020', 'DT-16': '2020', 'DT-17': '2020', 'DT-18': '2020',
            'DT-23': '2021', 'DT-24': '2021', 'DT-25': '2022', 'DT-26': '2022',
            'DT-27': '2022', 'DT-28': '2022', 'DT-29': '2022', 'DT-32': '2024',
            'DT-33': '2025', 'DT-34': '2025', 'DT-35': '2025', 'DT-36': '2020',
            'DT-37': '2020', 'DT-38': '2020', 'DT-39': '2020'
        };
        return yearMap[unit] || 'Unknown';
    }

    generateSessionId() {
        return 'SESS_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
    }

    showDriverApp() {
        const loginScreen = document.getElementById('loginScreen');
        const driverApp = document.getElementById('driverApp');
        
        if (loginScreen) loginScreen.style.display = 'none';
        if (driverApp) driverApp.style.display = 'block';
        
        const vehicleName = document.getElementById('vehicleName');
        const driverDisplayName = document.getElementById('driverDisplayName');
        
        if (vehicleName) vehicleName.textContent = this.driverData.unit;
        if (driverDisplayName) driverDisplayName.textContent = this.driverData.name;
        
        this.sessionStartTime = new Date();
        this.lastUpdateTime = new Date();
        this.updateSessionDuration();
        this.updateWaypointDisplay();
        this.setupChatSystem();
        
        // Start real GPS tracking
        this.startRealGPSTracking();
        
        this.addLog(`‚úÖ Login berhasil - ${this.driverData.name} (${this.driverData.unit})`, 'success');
        this.addLog('üîÑ Background tracking aktif - aplikasi tetap berjalan meski dimatikan', 'info');
    }

    processWaypoint(waypoint) {
        if (!this.isValidCoordinate(waypoint.lat, waypoint.lng)) {
            console.warn('‚ùå Invalid coordinates, skipping waypoint:', waypoint);
            return;
        }

        this.waypointBuffer.push(waypoint);
        this.unsyncedWaypoints.add(waypoint.id);
        this.storageManager.saveWaypoint(waypoint);
        
        if (!this.isInBackground) {
            this.updateGPSDisplay(waypoint);
            this.updateWaypointDisplay();
        }
        
        this.dataPoints++;
        if (!this.isInBackground) {
            document.getElementById('dataPoints').textContent = this.dataPoints;
        }

        console.log(`üìç ${waypoint.isBackground ? 'BACKGROUND' : 'FOREGROUND'} GPS: ${waypoint.lat}, ${waypoint.lng}, Speed: ${waypoint.speed} km/h`);
    }

    updateGPSDisplay(waypoint) {
        document.getElementById('currentLat').textContent = waypoint.lat.toFixed(6);
        document.getElementById('currentLng').textContent = waypoint.lng.toFixed(6);
        document.getElementById('currentSpeed').textContent = this.currentSpeed.toFixed(1);
        document.getElementById('gpsAccuracy').textContent = waypoint.accuracy.toFixed(1) + ' m';
        document.getElementById('gpsBearing').textContent = waypoint.bearing ? waypoint.bearing + '¬∞' : '-';
    }

    updateWaypointDisplay() {
        const waypointCount = document.getElementById('waypointCount');
        const unsyncedCount = document.getElementById('unsyncedCount');
        const waypointStatus = document.getElementById('waypointStatus');

        if (waypointCount) waypointCount.textContent = this.waypointBuffer.count;
        if (unsyncedCount) unsyncedCount.textContent = this.unsyncedWaypoints.size;
        if (waypointStatus) {
            waypointStatus.textContent = this.isOnline ? 
                'üü¢ Mengumpulkan waypoint...' : 
                `üî¥ Offline (${this.unsyncedWaypoints.size} menunggu sync)`;
        }
    }

    updateAverageSpeed() {
        if (this.dataPoints > 0 && this.sessionStartTime && this.totalDistance > 0) {
            const durationHours = (new Date() - this.sessionStartTime) / 3600000;
            const avgSpeed = durationHours > 0 ? this.totalDistance / durationHours : 0;
            
            if (!this.isInBackground) {
                document.getElementById('avgSpeed').textContent = avgSpeed.toFixed(1);
            }
        }
    }

    async sendToFirebase() {
        if (!this.firebaseRef || !this.lastPosition) return;

        try {
            const gpsData = {
                driver: this.driverData.name,
                unit: this.driverData.unit,
                lat: parseFloat(this.lastPosition.lat.toFixed(6)),
                lng: parseFloat(this.lastPosition.lng.toFixed(6)),
                speed: parseFloat(this.currentSpeed.toFixed(1)),
                accuracy: parseFloat(this.lastPosition.accuracy.toFixed(1)),
                bearing: this.lastPosition.bearing ? parseFloat(this.lastPosition.bearing.toFixed(0)) : null,
                timestamp: new Date().toISOString(),
                lastUpdate: new Date().toLocaleTimeString('id-ID'),
                distance: parseFloat(this.totalDistance.toFixed(3)),
                journeyStatus: this.journeyStatus,
                batteryLevel: this.getBatteryLevel(),
                sessionId: this.driverData.sessionId,
                isOfflineData: false,
                fuel: this.calculateFuelLevel(),
                gpsMode: 'real',
                isActive: true,
                isBackground: this.isInBackground,
                appState: this.isInBackground ? 'background' : 'foreground'
            };

            if (this.isOnline) {
                await this.firebaseRef.set(gpsData);
                if (!this.isInBackground) {
                    this.addLog(`üì° Data terkirim: ${this.currentSpeed.toFixed(1)} km/h | ${this.totalDistance.toFixed(3)} km`, 'success');
                }
                this.updateConnectionStatus(true);
            } else {
                this.offlineQueue.addToQueue(gpsData);
                if (!this.isInBackground) {
                    this.addLog(`üíæ Data disimpan offline (${this.offlineQueue.getQueueSize()} dalam antrian)`, 'warning');
                }
                this.updateConnectionStatus(false);
            }
            
        } catch (error) {
            console.error('Error sending to Firebase:', error);
            if (!this.isInBackground) {
                this.addLog(`‚ùå Gagal kirim data`, 'error');
            }
        }
    }

    calculateFuelLevel() {
        const baseFuel = 100;
        const fuelConsumptionRate = 0.25;
        const fuelUsed = this.totalDistance * fuelConsumptionRate;
        const remainingFuel = Math.max(0, baseFuel - fuelUsed);
        return Math.min(100, Math.max(0, Math.round(remainingFuel)));
    }

    getBatteryLevel() {
        // Simulate battery level - in real app, use navigator.getBattery() if available
        if (navigator.getBattery) {
            navigator.getBattery().then(battery => {
                return Math.round(battery.level * 100);
            });
        }
        return Math.max(20, Math.floor(Math.random() * 100));
    }

    checkNetworkStatus() {
        const wasOnline = this.isOnline;
        this.isOnline = navigator.onLine;
        
        if (wasOnline !== this.isOnline) {
            if (this.isOnline) {
                if (!this.isInBackground) {
                    this.addLog('üì± Koneksi pulih - sync semua waypoint', 'success');
                }
                this.updateConnectionStatus(true);
                
                setTimeout(() => {
                    this.syncWaypointsToServer();
                    this.offlineQueue.processQueue();
                }, 2000);
                
            } else {
                if (!this.isInBackground) {
                    this.addLog('üì± Koneksi terputus - menyimpan waypoint lokal', 'warning');
                }
                this.updateConnectionStatus(false);
            }
        }
        
        this.updateConnectionStatus(this.isOnline);
    }

    updateConnectionStatus(connected) {
        if (this.isInBackground) return; // Don't update UI in background
        
        const dot = document.getElementById('connectionDot');
        const status = document.getElementById('connectionStatus');
        
        if (connected) {
            if (dot) dot.className = 'connection-status connected';
            if (status) {
                status.textContent = 'TERHUBUNG';
                status.className = 'text-success';
            }
        } else {
            if (dot) dot.className = 'connection-status disconnected';
            if (status) {
                status.textContent = `OFFLINE (${this.unsyncedWaypoints.size} waypoint menunggu)`;
                status.className = 'text-danger';
                
                const queueSize = this.offlineQueue.getQueueSize();
                if (queueSize > 0) {
                    status.textContent = `OFFLINE (${this.unsyncedWaypoints.size} waypoint, ${queueSize} data antrian)`;
                }
            }
        }
        
        this.updateWaypointDisplay();
    }

    addLog(message, type = 'info') {
        if (this.isInBackground) return; // Don't add logs in background to save memory
        
        const logContainer = document.getElementById('dataLogs');
        if (!logContainer) return;

        const alertClass = {
            'info': 'alert-info',
            'success': 'alert-success', 
            'error': 'alert-danger',
            'warning': 'alert-warning'
        }[type] || 'alert-info';

        const logEntry = document.createElement('div');
        logEntry.className = `alert ${alertClass} py-2 mb-2`;
        logEntry.innerHTML = `
            <small>${new Date().toLocaleTimeString('id-ID')}: ${message}</small>
        `;
        
        logContainer.insertBefore(logEntry, logContainer.firstChild);
        
        if (logContainer.children.length > 6) {
            logContainer.removeChild(logContainer.lastChild);
        }
    }

    updateTime() {
        if (this.isInBackground) return;
        
        const currentTimeEl = document.getElementById('currentTime');
        if (currentTimeEl) {
            currentTimeEl.textContent = new Date().toLocaleTimeString('id-ID');
        }
    }

    updateSessionDuration() {
        if (!this.sessionStartTime || this.isInBackground) return;
        
        const now = new Date();
        const diff = now - this.sessionStartTime;
        const hours = Math.floor(diff / 3600000);
        const minutes = Math.floor((diff % 3600000) / 60000);
        const seconds = Math.floor((diff % 60000) / 1000);
        
        const sessionDurationEl = document.getElementById('sessionDuration');
        if (sessionDurationEl) {
            sessionDurationEl.textContent = 
                `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
        }
        
        setTimeout(() => this.updateSessionDuration(), 1000);
    }

    startJourney() {
        this.journeyStatus = 'started';
        this.lastUpdateTime = new Date();
        const vehicleStatus = document.getElementById('vehicleStatus');
        if (vehicleStatus && !this.isInBackground) {
            vehicleStatus.textContent = 'ON TRIP';
            vehicleStatus.className = 'bg-success text-white rounded px-2 py-1';
        }
        this.addLog('Perjalanan dimulai - GPS tracking aktif', 'success');
        this.sendToFirebase();
    }

    pauseJourney() {
        this.journeyStatus = 'paused';
        const vehicleStatus = document.getElementById('vehicleStatus');
        if (vehicleStatus && !this.isInBackground) {
            vehicleStatus.textContent = 'PAUSED';
            vehicleStatus.className = 'bg-warning text-dark rounded px-2 py-1';
        }
        this.addLog('Perjalanan dijeda', 'warning');
        this.sendToFirebase();
    }

    endJourney() {
        this.journeyStatus = 'ended';
        const vehicleStatus = document.getElementById('vehicleStatus');
        if (vehicleStatus && !this.isInBackground) {
            vehicleStatus.textContent = 'COMPLETED';
            vehicleStatus.className = 'bg-info text-white rounded px-2 py-1';
        }
        this.addLog(`Perjalanan selesai - Total jarak: ${this.totalDistance.toFixed(3)} km`, 'info');
        this.sendToFirebase();
        
        if (this.isOnline) {
            this.syncWaypointsToServer();
        }
    }

    reportIssue() {
        if (this.isInBackground) return;
        
        const issues = [
            'Mesin bermasalah', 'Ban bocor', 'Bahan bakar habis',
            'Kecelakaan kecil', 'Lainnya'
        ];
        
        const issue = prompt('Lapor masalah:\n' + issues.join('\n'));
        if (issue) {
            this.addLog(`Laporan: ${issue}`, 'warning');
        }
    }

    // ‚úÖ DEBUG METHODS
    sendTestMessage() {
        const testMessages = [
            "Lokasi saya saat ini aman",
            "Perjalanan lancar, tidak ada kendala", 
            "Estimasi sampai 30 menit lagi",
            "Butuh istirahat sebentar",
            "Bahan bakar masih cukup"
        ];
        
        const randomMessage = testMessages[Math.floor(Math.random() * testMessages.length)];
        this.sendMessage(randomMessage);
    }

    forceSync() {
        this.addLog('üîÑ Memaksa sinkronisasi data...', 'info');
        this.syncWaypointsToServer();
        if (this.offlineQueue.getQueueSize() > 0) {
            this.offlineQueue.processQueue();
        }
    }

    async runGPSDiagnostic() {
        this.addLog('üì° Menjalankan diagnostic GPS...', 'info');
        
        if (!navigator.geolocation) {
            this.addLog('‚ùå GPS tidak didukung di browser ini', 'error');
            return;
        }

        try {
            const position = await new Promise((resolve, reject) => {
                navigator.geolocation.getCurrentPosition(resolve, reject, {
                    enableHighAccuracy: true,
                    timeout: 10000,
                    maximumAge: 0
                });
            });

            const accuracy = position.coords.accuracy;
            const diagnosticMessage = `
‚úÖ GPS Diagnostic Result:
‚Ä¢ Latitude: ${position.coords.latitude.toFixed(6)}
‚Ä¢ Longitude: ${position.coords.longitude.toFixed(6)}
‚Ä¢ Accuracy: ${accuracy}m
‚Ä¢ Speed: ${position.coords.speed ? (position.coords.speed * 3.6).toFixed(1) + ' km/h' : 'N/A'}
‚Ä¢ Altitude: ${position.coords.altitude ? position.coords.altitude.toFixed(1) + 'm' : 'N/A'}
‚Ä¢ Heading: ${position.coords.heading ? position.coords.heading + '¬∞' : 'N/A'}
‚Ä¢ Timestamp: ${new Date().toLocaleTimeString('id-ID')}
            `.trim();

            this.addLog(diagnosticMessage, 'success');

            if (accuracy > 50) {
                this.addLog('‚ö†Ô∏è Akurasi GPS sedang - cari area terbuka untuk hasil terbaik', 'warning');
            }

        } catch (error) {
            this.addLog(`‚ùå GPS Diagnostic Failed: ${this.getGPSErrorMessage(error)}`, 'error');
        }
    }

    getGPSErrorMessage(error) {
        switch(error.code) {
            case error.PERMISSION_DENIED: return 'Izin GPS ditolak';
            case error.POSITION_UNAVAILABLE: return 'Posisi tidak tersedia';
            case error.TIMEOUT: return 'Timeout GPS';
            default: return 'Error tidak diketahui';
        }
    }

    // ‚úÖ CHAT SYSTEM (Optimized for Background)
    setupChatSystem() {
        if (!this.driverData) return;
        
        console.log('üí¨ Setting up enhanced chat system for unit:', this.driverData.unit);
        
        this.chatRef = database.ref('/chat/' + this.driverData.unit);
        this.chatRef.off();
        
        this.chatRef.on('child_added', (snapshot) => {
            const message = snapshot.val();
            if (message && message.id !== this.lastMessageId) {
                this.handleNewMessage(message);
            }
        });
        
        this.chatInitialized = true;
        console.log('üí¨ Enhanced chat system activated for unit:', this.driverData.unit);
        this.addLog('Sistem chat aktif - bisa komunikasi real-time dengan monitor', 'success');
    }

    handleNewMessage(message) {
        if (!message || message.sender === this.driverData.name) return;
        
        const messageExists = this.chatMessages.some(msg => 
            msg.id === message.id || 
            (msg.timestamp === message.timestamp && msg.sender === message.sender)
        );
        
        if (messageExists) return;
        
        this.chatMessages.push(message);
        
        if (!this.isChatOpen || message.sender !== this.driverData.name) {
            this.unreadCount++;
        }
        
        this.updateChatUI();
        
        if (!this.isChatOpen && message.sender !== this.driverData.name) {
            this.showChatNotification(message);
        }
        
        this.playNotificationSound();
        console.log('üí¨ New message received:', message);
    }

    async sendMessage(messageText) {
        if (!messageText.trim() || !this.chatRef || !this.driverData) return;
        
        const messageId = 'msg_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
        
        const messageData = {
            id: messageId,
            text: messageText.trim(),
            sender: this.driverData.name,
            unit: this.driverData.unit,
            timestamp: new Date().toISOString(),
            timeDisplay: new Date().toLocaleTimeString('id-ID', { 
                hour: '2-digit', minute: '2-digit' 
            }),
            type: 'driver',
            status: 'sent'
        };
        
        try {
            await this.chatRef.push(messageData);
            this.lastMessageId = messageId;
            
            this.chatMessages.push(messageData);
            this.updateChatUI();
            this.addLog(`üí¨ Pesan terkirim: "${messageText}"`, 'info');
            
        } catch (error) {
            console.error('Failed to send message:', error);
            this.addLog('‚ùå Gagal mengirim pesan', 'error');
            
            messageData.status = 'failed';
            this.chatMessages.push(messageData);
            this.updateChatUI();
        }
    }

    sendChatMessage() {
        const input = document.getElementById('chatInput');
        if (input && input.value.trim()) {
            this.sendMessage(input.value);
            input.value = '';
        }
    }

    updateChatUI() {
        if (this.isInBackground) return;
        
        const messageList = document.getElementById('chatMessages');
        const unreadBadge = document.getElementById('unreadBadge');
        const chatToggle = document.getElementById('chatToggle');
        
        if (!messageList) return;
        
        if (unreadBadge) {
            unreadBadge.textContent = this.unreadCount > 0 ? this.unreadCount : '';
            unreadBadge.style.display = this.unreadCount > 0 ? 'inline' : 'none';
        }
        
        if (chatToggle) {
            chatToggle.innerHTML = this.unreadCount > 0 ? 
                `üí¨ Chat <span class="badge bg-danger">${this.unreadCount}</span>` : 
                'üí¨ Chat';
        }
        
        messageList.innerHTML = '';
        
        if (this.chatMessages.length === 0) {
            messageList.innerHTML = `
                <div class="chat-placeholder text-center text-muted py-4">
                    <small>Mulai percakapan dengan monitor...</small>
                </div>
            `;
            return;
        }
        
        this.chatMessages.forEach(message => {
            const messageElement = this.createMessageElement(message);
            messageList.appendChild(messageElement);
        });
        
        messageList.scrollTop = messageList.scrollHeight;
    }

    createMessageElement(message) {
        const messageElement = document.createElement('div');
        const isSentMessage = message.sender === this.driverData.name;
        
        messageElement.className = `chat-message ${isSentMessage ? 'message-sent' : 'message-received'}`;
        
        messageElement.innerHTML = `
            <div class="message-content ${message.status === 'failed' ? 'message-failed' : ''}">
                ${!isSentMessage ? 
                    `<div class="message-sender">${this.escapeHtml(message.sender)}</div>` : ''}
                <div class="message-text">${this.escapeHtml(message.text)}</div>
                <div class="message-footer">
                    <span class="message-time">${message.timeDisplay}</span>
                    ${isSentMessage ? 
                        `<span class="message-status">${message.status === 'failed' ? '‚ùå' : '‚úì'}</span>` : ''}
                </div>
            </div>
        `;
        
        return messageElement;
    }

    toggleChat() {
        if (this.isInBackground) return;
        
        this.isChatOpen = !this.isChatOpen;
        const chatWindow = document.getElementById('chatWindow');
        
        if (chatWindow) {
            chatWindow.style.display = this.isChatOpen ? 'flex' : 'none';
            
            if (this.isChatOpen) {
                this.unreadCount = 0;
                this.updateChatUI();
                setTimeout(() => {
                    const chatInput = document.getElementById('chatInput');
                    if (chatInput) chatInput.focus();
                }, 100);
            }
        }
    }

    showChatNotification(message) {
        if (this.isInBackground) return;
        
        const notification = document.createElement('div');
        notification.className = 'chat-notification alert alert-info';
        notification.innerHTML = `
            <div class="d-flex justify-content-between align-items-start">
                <div>
                    <strong>üí¨ Pesan Baru dari ${message.sender}</strong>
                    <div class="small">${message.text}</div>
                </div>
                <button type="button" class="btn-close btn-sm" onclick="this.parentElement.parentElement.remove()"></button>
            </div>
        `;
        
        notification.style.cssText = `
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 9999;
            min-width: 300px;
            max-width: 400px;
        `;
        
        document.body.appendChild(notification);
        
        setTimeout(() => {
            if (notification.parentNode) {
                notification.remove();
            }
        }, 5000);
    }

    playNotificationSound() {
        try {
            const audioContext = new (window.AudioContext || window.webkitAudioContext)();
            const oscillator = audioContext.createOscillator();
            const gainNode = audioContext.createGain();
            
            oscillator.connect(gainNode);
            gainNode.connect(audioContext.destination);
            
            oscillator.frequency.setValueAtTime(800, audioContext.currentTime);
            oscillator.frequency.setValueAtTime(600, audioContext.currentTime + 0.1);
            
            gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
            gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.2);
            
            oscillator.start(audioContext.currentTime);
            oscillator.stop(audioContext.currentTime + 0.2);
        } catch (error) {
            console.log('Notification sound not supported');
        }
    }

    escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }

    loadUnsyncedWaypoints() {
        const unsynced = this.storageManager.loadUnsyncedWaypoints();
        unsynced.forEach(waypoint => {
            this.waypointBuffer.push(waypoint);
            if (!waypoint.synced) {
                this.unsyncedWaypoints.add(waypoint.id);
            }
        });
        console.log(`üìÇ Loaded ${unsynced.length} waypoints from storage`);
    }

    loadCompleteHistory() {
        try {
            const saved = localStorage.getItem('gps_complete_history');
            return saved ? JSON.parse(saved) : [];
        } catch (error) {
            console.error('Error loading history:', error);
            return [];
        }
    }

    async syncWaypointsToServer() {
        if (!this.isOnline || !this.driverData) {
            console.log('‚ùå Cannot sync: Offline or no driver data');
            return;
        }

        const unsynced = this.getUnsyncedWaypoints();
        if (unsynced.length === 0) {
            console.log('‚úÖ All waypoints synced');
            return;
        }

        console.log(`üîÑ Syncing ${unsynced.length} waypoints to server...`);
        
        const batches = this.createBatches(unsynced, this.waypointConfig.batchSize);
        let successfulBatches = 0;

        for (const [index, batch] of batches.entries()) {
            try {
                await this.uploadBatch(batch, index);
                successfulBatches++;
                
                batch.forEach(waypoint => {
                    waypoint.synced = true;
                    this.unsyncedWaypoints.delete(waypoint.id);
                });
                
                this.storageManager.markWaypointsAsSynced(batch.map(wp => wp.id));
                if (!this.isInBackground) {
                    this.addLog(`üì° Batch ${index + 1}/${batches.length} synced (${batch.length} waypoints)`, 'success');
                }
                
            } catch (error) {
                console.error(`‚ùå Batch ${index + 1} sync failed:`, error);
                if (!this.isInBackground) {
                    this.addLog(`‚ùå Batch ${index + 1} sync failed`, 'error');
                }
                break;
            }
        }

        if (successfulBatches > 0 && !this.isInBackground) {
            this.addLog(`‚úÖ ${successfulBatches} batches synced successfully`, 'success');
            this.updateWaypointDisplay();
        }
    }

    async uploadBatch(batch, batchIndex) {
        const batchId = `batch_${this.driverData.unit}_${Date.now()}_${batchIndex}`;
        const batchRef = database.ref(`/waypoints/${this.driverData.unit}/batches/${batchId}`);
        
        const batchData = {
            batchId: batchId,
            unit: this.driverData.unit,
            sessionId: this.driverData.sessionId,
            driver: this.driverData.name,
            waypoints: batch,
            uploadedAt: new Date().toISOString(),
            batchSize: batch.length,
            totalWaypoints: this.waypointBuffer.count,
            batchIndex: batchIndex
        };

        await batchRef.set(batchData);
        console.log(`‚úÖ Batch ${batchIndex} uploaded: ${batch.length} waypoints`);
    }

    getUnsyncedWaypoints() {
        return this.waypointBuffer.getAll().filter(wp => !wp.synced);
    }

    createBatches(array, batchSize) {
        const batches = [];
        for (let i = 0; i < array.length; i += batchSize) {
            batches.push(array.slice(i, i + batchSize));
        }
        return batches;
    }

    stopTracking() {
        if (this.watchId) {
            navigator.geolocation.clearWatch(this.watchId);
        }
        if (this.sendInterval) {
            clearInterval(this.sendInterval);
        }
        if (this.firebaseRef) {
            this.firebaseRef.remove();
        }
        
        this.stopRealGPSTracking();
        this.isTracking = false;
    }

    stopRealGPSTracking() {
        if (this.watchId) {
            navigator.geolocation.clearWatch(this.watchId);
            this.watchId = null;
        }
        this.isTracking = false;
    }

    // ‚úÖ ENHANCED LOGOUT WITH COMPLETE SESSION CLEANUP
    logout() {
        if (confirm('Yakin ingin logout? Tracking akan dihentikan permanen.')) {
            // Stop all tracking
            this.stopRealGPSTracking();
            this.backgroundManager.stop();
            
            if (this.sendInterval) {
                clearInterval(this.sendInterval);
            }
            
            // Update Firebase status to offline
            if (this.firebaseRef) {
                this.firebaseRef.update({
                    isActive: false,
                    lastUpdate: new Date().toLocaleTimeString('id-ID'),
                    journeyStatus: 'ended',
                    timestamp: new Date().toISOString()
                }).catch(error => {
                    console.error('Error updating Firebase status:', error);
                });
            }
            
            if (this.chatRef) {
                this.chatRef.off();
            }
            
            // Clear persisted session
            this.clearPersistedSession();
            
            // Sync any remaining data
            if (this.isOnline) {
                this.syncWaypointsToServer();
                this.offlineQueue.processQueue();
            }
            
            const sessionSummary = {
                driver: this.driverData.name,
                unit: this.driverData.unit,
                duration: document.getElementById('sessionDuration')?.textContent || '00:00:00',
                totalDistance: this.totalDistance.toFixed(3),
                dataPoints: this.dataPoints,
                waypointsCollected: this.waypointBuffer.count,
                unsyncedWaypoints: this.unsyncedWaypoints.size,
                avgSpeed: document.getElementById('avgSpeed')?.textContent || '0',
                sessionId: this.driverData.sessionId
            };
            
            console.log('Session Summary:', sessionSummary);
            this.addLog(`Session ended - ${this.waypointBuffer.count} waypoints collected`, 'info');
            
            // Reset all data
            this.waypointBuffer.clear();
            this.unsyncedWaypoints.clear();
            
            this.driverData = null;
            this.firebaseRef = null;
            this.chatRef = null;
            this.chatMessages = [];
            this.unreadCount = 0;
            this.isChatOpen = false;
            this.chatInitialized = false;
            
            const loginScreen = document.getElementById('loginScreen');
            const driverApp = document.getElementById('driverApp');
            const loginForm = document.getElementById('loginForm');
            
            if (loginScreen) loginScreen.style.display = 'block';
            if (driverApp) driverApp.style.display = 'none';
            if (loginForm) loginForm.reset();
            
            this.totalDistance = 0;
            this.dataPoints = 0;
            this.lastPosition = null;
            this.lastUpdateTime = null;
            this.isTracking = false;
            
            this.addLog('‚úÖ Logout berhasil - semua tracking dihentikan', 'success');
        }
    }
}

// ‚úÖ ENHANCED OFFLINE QUEUE MANAGER
class OfflineQueueManager {
    constructor() {
        this.queue = [];
        this.isOnline = navigator.onLine;
        this.maxQueueSize = 1000; // Prevent memory issues
    }

    addToQueue(gpsData) {
        // Prevent queue from growing too large
        if (this.queue.length >= this.maxQueueSize) {
            // Remove oldest 10% of items
            const removeCount = Math.floor(this.maxQueueSize * 0.1);
            this.queue.splice(0, removeCount);
            console.log(`üóëÔ∏è Removed ${removeCount} old items from offline queue`);
        }
        
        this.queue.push({
            ...gpsData,
            queueTimestamp: new Date().toISOString(),
            queueId: `queue_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`
        });
        console.log(`üíæ Saved to offline queue. Total: ${this.queue.length}`);
    }

    getQueueSize() {
        return this.queue.length;
    }

    async processQueue() {
        if (this.queue.length === 0 || !this.isOnline) return;

        console.log(`üîÑ Processing ${this.queue.length} queued items...`);
        
        const successItems = [];
        const failedItems = [];

        for (const item of this.queue) {
            try {
                await this.sendQueuedData(item);
                successItems.push(item);
            } catch (error) {
                console.error('Failed to send queued data:', error);
                failedItems.push(item);
                
                // Stop processing if we encounter too many errors
                if (failedItems.length > 5) {
                    console.warn('Too many failures, stopping queue processing');
                    break;
                }
            }
        }

        this.queue = failedItems;

        console.log(`‚úÖ Sent ${successItems.length} items, ${failedItems.length} failed`);
        
        if (successItems.length > 0 && window.dtLogger && !window.dtLogger.isInBackground) {
            window.dtLogger.addLog(`üì° Sync offline: ${successItems.length} data terkirim`, 'success');
        }
    }

    async sendQueuedData(queuedData) {
        if (!window.dtLogger?.firebaseRef) {
            throw new Error('No Firebase reference');
        }

        const { queueTimestamp, queueId, ...cleanData } = queuedData;
        await window.dtLogger.firebaseRef.set(cleanData);
    }
}

// Initialize app with enhanced error handling
document.addEventListener('DOMContentLoaded', function() {
    try {
        window.dtLogger = new EnhancedDTGPSLogger();
        console.log('‚úÖ Enhanced DT GPS Logger successfully initialized');
    } catch (error) {
        console.error('‚ùå Failed to initialize Enhanced DT GPS Logger:', error);
        alert('Gagal menginisialisasi aplikasi. Silakan refresh halaman.');
    }
});

// Enhanced visibility change handling with error recovery
document.addEventListener('visibilitychange', function() {
    if (window.dtLogger && window.dtLogger.driverData) {
        if (document.hidden) {
            console.log('üì± App moved to background - background tracking active');
            // Persist session when going to background
            window.dtLogger.persistSession();
        } else {
            if (!window.dtLogger.isInBackground) {
                window.dtLogger.addLog('üì± App aktif kembali', 'success');
            }
            // Update UI with latest data
            window.dtLogger.updateWaypointDisplay();
            window.dtLogger.updateSessionDuration();
        }
    }
});

// Handle page freeze and resume events
window.addEventListener('freeze', () => {
    if (window.dtLogger) {
        console.log('‚ùÑÔ∏è Page freezing, persisting session...');
        window.dtLogger.persistSession();
    }
});

window.addEventListener('resume', () => {
    if (window.dtLogger && window.dtLogger.driverData) {
        console.log('üîÅ Page resuming from freeze...');
        window.dtLogger.addLog('üîÅ App dilanjutkan dari sleep mode', 'info');
        // Re-initialize tracking if needed
        if (!window.dtLogger.isTracking) {
            window.dtLogger.startRealGPSTracking();
        }
    }
});

// Network status recovery
window.addEventListener('online', () => {
    if (window.dtLogger) {
        setTimeout(() => {
            window.dtLogger.syncWaypointsToServer();
            window.dtLogger.offlineQueue.processQueue();
        }, 1000);
    }
});

// Error boundary for unhandled errors
window.addEventListener('error', (event) => {
    console.error('Global error caught:', event.error);
    if (window.dtLogger && !window.dtLogger.isInBackground) {
        window.dtLogger.addLog('‚ö†Ô∏è Error sistem, tetapi aplikasi tetap berjalan', 'warning');
    }
});

window.addEventListener('unhandledrejection', (event) => {
    console.error('Unhandled promise rejection:', event.reason);
});
    </script>
</body>
</html>
